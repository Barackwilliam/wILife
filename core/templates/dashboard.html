{% extends 'base.html' %}
{% load static %}
{% block content %}

<div class="container py-5">
  <h2 class="text-center mb-5">üìä Personal Dashboard for {{ request.user.username }}</h2>

  <div class="row g-4 mb-4">
    <div class="col-md-4">
      <div class="card p-3">
        <h5>üí∞ Total Income</h5>
        <h3 class="text-success">Tsh.{{ income_total }}/=</h3>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3">
        <h5>üí∏ Total Expenses</h5>
        <h3 class="text-danger">Tsh.{{ expense_total }}/=</h3>
        <small>Spending vs Income</small>
        <div class="progress">
          <div class="progress-bar bg-danger" style="width: {{ expense_vs_income_percent }}%">{{ expense_vs_income_percent|floatformat:0 }}%</div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3">
        <h5>üìÖ Tasks Overview</h5>
        <div>Pending: {{ tasks_pending }}</div>
        <div class="progress mb-2">
          <div class="progress-bar bg-warning" style="width: {{ tasks_pending_percent }}%">{{ tasks_pending_percent|floatformat:0 }}%</div>
        </div>
        <div>Completed: {{ tasks_done }}</div>
        <div class="progress">
          <div class="progress-bar bg-success" style="width: {{ tasks_done_percent }}%">{{ tasks_done_percent|floatformat:0 }}%</div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4 mb-4">
    <div class="col-md-6">
      <div class="card p-3">
        <h5 class="section-title">üè• Health Insights</h5>
        <ul class="list-group list-group-flush">
          <li class="list-group-item bg-transparent text-dark">Weight (avg): {{ health_avg.avg_weight|floatformat:2|default:"N/A" }}</li>
          <li class="list-group-item bg-transparent text-dark">Exercise (avg): {{ health_avg.avg_exercise|default:"N/A" }} min</li>
          <li class="list-group-item bg-transparent text-dark">Sleep (avg): {{ health_avg.avg_sleep|default:"N/A" }} hrs</li>
        </ul>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card p-3">
        <h5 class="section-title">üìä Expense Categories - Bar Chart</h5>
        <canvas id="expenseBarChart"></canvas>
      </div>
    </div>
  </div>

  <div class="row g-4 mb-4">
    <div class="col-md-12">
      <div class="card p-3">
        <h5 class="section-title">üßÅ Expense Categories - Pie Chart</h5>
        <canvas id="expensePieChart" style="max-width: 400px; max-height: 400px; margin: auto; display: block;"></canvas>
      </div>
    </div>
  </div>

  <!-- Menstrual Cycle Data Section -->
  <div class="row g-4 mb-4">
    <div class="col-md-6">
      <div class="card p-3">
        <h5 class="section-title">ü©∏ Menstrual Flow Levels - Pie Chart</h5>
        <canvas id="menstrualFlowPieChart" style="max-width: 400px; margin: auto; display: block;"></canvas>
        <p class="mt-3 text-center text-muted">
          This chart shows the distribution of your menstrual flow levels recorded over time.
        </p>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card p-3">
        <h5 class="section-title">üìà Menstrual Cycle Length - Bar Chart</h5>
        <canvas id="menstrualCycleBarChart" style="max-width: 400px; margin: auto; display: block;"></canvas>
        <p class="mt-3 text-center text-muted">
          This chart illustrates the length of your menstrual cycles (in days).
        </p>
      </div>
    </div>
  </div>

  <div class="card p-4">
    <h5 class="section-title">üí° Smart Recommendations</h5>
    {% if recommendations %}
      <ul class="list-group list-group-flush">
        {% for r in recommendations %}
          <li class="list-group-item bg-transparent text-dark">‚ö†Ô∏è {{ r }}</li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-success">‚úÖ Everything looks great! Keep it up!</p>
    {% endif %}
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Expense bar chart
  const barCtx = document.getElementById('expenseBarChart').getContext('2d');
  const pieCtx = document.getElementById('expensePieChart').getContext('2d');
  const expenseLabels = {{ categories|safe }};
  const expenseData = {{ expense_data|safe }};

  new Chart(barCtx, {
    type: 'bar',
    data: {
      labels: expenseLabels,
      datasets: [{
        label: 'Expenses (Tsh)',
        data: expenseData,
        backgroundColor: '#0dcaf0'
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });

  // Expense pie chart
  new Chart(pieCtx, {
    type: 'pie',
    data: {
      labels: expenseLabels,
      datasets: [{
        label: 'Expense Share',
        data: expenseData,
        backgroundColor: [
          '#0dcaf0', '#ffc107', '#fd7e14', '#dc3545', '#20c997', '#6f42c1', '#198754'
        ]
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' }
      }
    }
  });

  // Menstrual flow levels pie chart
  const flowCtx = document.getElementById('menstrualFlowPieChart').getContext('2d');
  const menstrualFlowLabels = {{ menstrual_flow_levels.labels|safe }};
  const menstrualFlowData = {{ menstrual_flow_levels.data|safe }};

  new Chart(flowCtx, {
    type: 'pie',
    data: {
      labels: menstrualFlowLabels,
      datasets: [{
        label: 'Menstrual Flow Levels',
        data: menstrualFlowData,
        backgroundColor: ['#d81b60', '#ec407a', '#f48fb1']
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' }
      }
    }
  });

  // Menstrual cycle length bar chart
  const cycleCtx = document.getElementById('menstrualCycleBarChart').getContext('2d');
  const menstrualCycleLabels = {{ menstrual_cycle_lengths.labels|safe }};
  const menstrualCycleData = {{ menstrual_cycle_lengths.data|safe }};

  new Chart(cycleCtx, {
    type: 'bar',
    data: {
      labels: menstrualCycleLabels,
      datasets: [{
        label: 'Cycle Length (days)',
        data: menstrualCycleData,
        backgroundColor: '#6a1b9a'
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          stepSize: 1,
          title: { display: true, text: 'Days' }
        }
      }
    }
  });
</script>

{% endblock %}
